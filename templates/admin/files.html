{% extends "layouts/base.html" %} {% block title %}File Management - GiziAI
Admin{% endblock title %} {% block content %}
<div class="row">
  <div class="col-12">
    <div class="card my-4">
      <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
        <div
          class="bg-gradient-primary shadow-primary border-radius-lg pt-4 pb-3"
        >
          <div class="row">
            <div class="col-lg-6 col-7">
              <h6 class="text-white text-capitalize ps-3">File Management</h6>
              <p class="text-sm text-white ps-3 mb-0">
                Manage your document files
              </p>
            </div>
            <div class="col-lg-6 col-5 my-auto text-end">
              <button
                class="btn btn-outline-white btn-sm mb-0 me-3"
                onclick="$('#uploadModal').modal('show')"
              >
                <i class="material-icons text-sm">cloud_upload</i
                >&nbsp;&nbsp;Upload File
              </button>
              <button
                class="btn btn-outline-white btn-sm mb-0 me-3"
                onclick="refreshFiles()"
              >
                <i class="material-icons text-sm">refresh</i>&nbsp;&nbsp;Refresh
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="card-body px-0 pb-2">
        <div class="table-responsive p-0">
          <table class="table align-items-center mb-0" id="filesTable">
            <thead>
              <tr>
                <th
                  class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7"
                >
                  File
                </th>
                <th
                  class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2"
                >
                  Type
                </th>
                <th
                  class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7"
                >
                  Status
                </th>
                <th
                  class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7"
                >
                  Upload Date
                </th>
                <th class="text-secondary opacity-7">Actions</th>
              </tr>
            </thead>
            <tbody id="filesTableBody">
              {% if files %} {% for file in files %}
              <tr data-file-id="{{ file.id }}">
                <td>
                  <div class="d-flex px-2 py-1">
                    <div>
                      {% if file.file_type == 'pdf' %}
                      <div class="avatar avatar-sm me-3 bg-gradient-danger">
                        <i class="material-icons opacity-10 text-white"
                          >picture_as_pdf</i
                        >
                      </div>
                      {% else %}
                      <div class="avatar avatar-sm me-3 bg-gradient-primary">
                        <i class="material-icons opacity-10 text-white"
                          >description</i
                        >
                      </div>
                      {% endif %}
                    </div>
                    <div class="d-flex flex-column justify-content-center">
                      <h6 class="mb-0 text-sm">{{ file.filename }}</h6>
                      <p class="text-xs text-secondary mb-0">Document file</p>
                    </div>
                  </div>
                </td>
                <td>
                  <p class="text-xs font-weight-bold mb-0">
                    {{ file.file_type.upper() }}
                  </p>
                  <p class="text-xs text-secondary mb-0">
                    {{ file.file_type }}
                  </p>
                </td>
                <td class="align-middle text-center text-sm">
                  {% if file.processed_at %}
                  <span class="badge badge-sm bg-gradient-success"
                    >Processed</span
                  >
                  {% else %}
                  <span class="badge badge-sm bg-gradient-warning"
                    >Processing</span
                  >
                  {% endif %}
                </td>
                <td class="align-middle text-center">
                  <span class="text-secondary text-xs font-weight-bold">
                    {{ file.uploaded_at.strftime('%d/%m/%Y %H:%M') if
                    file.uploaded_at else 'N/A' }}
                  </span>
                </td>
                <td class="align-middle">
                  <button
                    class="btn btn-link text-danger text-gradient px-3 mb-0"
                    onclick="deleteFile({{ file.id }}, '{{ file.filename }}')"
                  >
                    <i class="material-icons text-sm me-2">delete</i>Delete
                  </button>
                </td>
              </tr>
              {% endfor %} {% else %}
              <tr id="noFilesRow">
                <td colspan="5" class="text-center py-4">
                  <div class="text-center">
                    <i class="material-icons opacity-5" style="font-size: 4rem"
                      >folder_open</i
                    >
                    <h6 class="text-secondary">No files uploaded yet</h6>
                    <p class="text-sm text-secondary">
                      Start by uploading your first document
                    </p>
                    <button
                      class="btn btn-primary btn-sm"
                      onclick="$('#uploadModal').modal('show')"
                    >
                      <i class="material-icons text-sm">cloud_upload</i
                      >&nbsp;&nbsp;Upload First File
                    </button>
                  </div>
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="card-footer">
        <div class="row align-items-center">
          <div class="col-lg-6">
            <p class="text-sm mb-0">
              <i class="fa fa-check text-info" aria-hidden="true"></i>
              Supported formats: <strong>PDF, DOCX</strong>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div
  class="modal fade"
  id="uploadModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="uploadModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title font-weight-normal" id="uploadModalLabel">
          Upload Document File
        </h5>
        <button
          type="button"
          class="btn-close text-dark"
          data-bs-dismiss="modal"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form id="uploadForm" enctype="multipart/form-data">
        <div class="modal-body">
          <div class="input-group input-group-dynamic mb-4">
            <label class="form-label">Select File (PDF or DOCX)</label>
            <input
              type="file"
              class="form-control"
              id="fileInput"
              name="file"
              accept=".pdf,.docx,.doc"
              required
            />
          </div>
          <div class="form-text">
            <i class="material-icons text-sm">info</i>
            Supported formats: PDF, DOCX
          </div>
          <div id="uploadProgress" class="progress mt-3" style="display: none">
            <div
              class="progress-bar bg-gradient-info"
              role="progressbar"
              style="width: 0%"
            ></div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn bg-gradient-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn bg-gradient-primary" id="uploadBtn">
            <i class="material-icons text-sm">cloud_upload</i>&nbsp;&nbsp;Upload
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<div
  class="modal fade"
  id="deleteModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="deleteModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title font-weight-normal" id="deleteModalLabel">
          Confirm Delete
        </h5>
        <button
          type="button"
          class="btn-close text-dark"
          data-bs-dismiss="modal"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="text-center">
          <i class="material-icons text-warning" style="font-size: 3rem"
            >warning</i
          >
          <h6 class="mt-2">Are you sure?</h6>
          <p>
            You are about to delete the file "<span
              id="deleteFileName"
              class="font-weight-bold"
            ></span
            >".
          </p>
          <div class="alert alert-warning text-white">
            <span class="text-sm"
              ><strong>Warning:</strong> This action cannot be undone.</span
            >
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn bg-gradient-secondary"
          data-bs-dismiss="modal"
        >
          Cancel
        </button>
        <button
          type="button"
          class="btn bg-gradient-danger"
          id="confirmDeleteBtn"
        >
          <i class="material-icons text-sm">delete</i>&nbsp;&nbsp;Delete
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock content %} {% block javascripts %}
<script>
  let currentDeleteFileId = null;

  $("#uploadForm").on("submit", function (e) {
    e.preventDefault();

    const formData = new FormData(this);
    const uploadBtn = $("#uploadBtn");
    const progress = $("#uploadProgress");

    uploadBtn
      .prop("disabled", true)
      .html(
        '<i class="material-icons text-sm">hourglass_empty</i>&nbsp;&nbsp;Uploading...'
      );
    progress.show();

    $.ajax({
      url: '{{ url_for("admin.api_upload_file") }}',
      type: "POST",
      data: formData,
      processData: false,
      contentType: false,
      xhr: function () {
        var xhr = new window.XMLHttpRequest();
        xhr.upload.addEventListener(
          "progress",
          function (evt) {
            if (evt.lengthComputable) {
              var percentComplete = (evt.loaded / evt.total) * 100;
              $("#uploadProgress .progress-bar").css(
                "width",
                percentComplete + "%"
              );
            }
          },
          false
        );
        return xhr;
      },
      success: function (response) {
        if (response.success) {
          showAlert("success", response.message);
          $("#uploadModal").modal("hide");
          refreshFiles();
        } else {
          showAlert("danger", response.message);
        }
      },
      error: function (xhr) {
        const response = xhr.responseJSON || {};
        showAlert("danger", response.message || "Upload failed");
      },
      complete: function () {
        uploadBtn
          .prop("disabled", false)
          .html(
            '<i class="material-icons text-sm">cloud_upload</i>&nbsp;&nbsp;Upload'
          );
        progress.hide();
        $("#uploadProgress .progress-bar").css("width", "0%");
      },
    });
  });

  function deleteFile(fileId, fileName) {
    currentDeleteFileId = fileId;
    $("#deleteFileName").text(fileName);
    $("#deleteModal").modal("show");
  }

  $("#confirmDeleteBtn").on("click", function () {
    if (!currentDeleteFileId) return;

    const btn = $(this);
    btn
      .prop("disabled", true)
      .html(
        '<i class="material-icons text-sm">hourglass_empty</i>&nbsp;&nbsp;Deleting...'
      );

    const deleteUrl = "/admin/api/files/" + currentDeleteFileId;

    $.ajax({
      url: deleteUrl,
      type: "DELETE",
      success: function (response) {
        if (response.success) {
          showAlert("success", response.message);
          $("#deleteModal").modal("hide");
          refreshFiles();
        } else {
          showAlert("danger", response.message);
        }
      },
      error: function (xhr) {
        const response = xhr.responseJSON || {};
        showAlert("danger", response.message || "Delete failed");
      },
      complete: function () {
        btn
          .prop("disabled", false)
          .html(
            '<i class="material-icons text-sm">delete</i>&nbsp;&nbsp;Delete'
          );
        currentDeleteFileId = null;
      },
    });
  });

  function refreshFiles() {
    $.ajax({
      url: '{{ url_for("admin.api_get_files") }}',
      type: "GET",
      success: function (response) {
        if (response.success) {
          updateFilesTable(response.data);
        }
      },
      error: function () {
        showAlert("danger", "Failed to refresh files");
      },
    });
  }

  function updateFilesTable(files) {
    const tbody = $("#filesTableBody");
    tbody.empty();

    if (files.length === 0) {
      tbody.append(`
      <tr id="noFilesRow">
        <td colspan="5" class="text-center py-4">
          <div class="text-center">
            <i class="material-icons opacity-5" style="font-size: 4rem;">folder_open</i>
            <h6 class="text-secondary">No files uploaded yet</h6>
            <p class="text-sm text-secondary">Start by uploading your first document</p>
            <button class="btn btn-primary btn-sm" onclick="$('#uploadModal').modal('show')">
              <i class="material-icons text-sm">cloud_upload</i>&nbsp;&nbsp;Upload First File
            </button>
          </div>
        </td>
      </tr>
    `);
      return;
    }

    files.forEach((file) => {
      const icon =
        file.file_type === "pdf"
          ? '<div class="avatar avatar-sm me-3 bg-gradient-danger"><i class="material-icons opacity-10 text-white">picture_as_pdf</i></div>'
          : '<div class="avatar avatar-sm me-3 bg-gradient-primary"><i class="material-icons opacity-10 text-white">description</i></div>';

      const status = file.processed_at
        ? '<span class="badge badge-sm bg-gradient-success">Processed</span>'
        : '<span class="badge badge-sm bg-gradient-warning">Processing</span>';

      const uploadDate = file.uploaded_at
        ? new Date(file.uploaded_at).toLocaleDateString("id-ID") +
          " " +
          new Date(file.uploaded_at).toLocaleTimeString("id-ID", {
            hour: "2-digit",
            minute: "2-digit",
          })
        : "N/A";

      tbody.append(`
      <tr data-file-id="${file.id}">
        <td>
          <div class="d-flex px-2 py-1">
            <div>${icon}</div>
            <div class="d-flex flex-column justify-content-center">
              <h6 class="mb-0 text-sm">${file.filename}</h6>
              <p class="text-xs text-secondary mb-0">Document file</p>
            </div>
          </div>
        </td>
        <td>
          <p class="text-xs font-weight-bold mb-0">${file.file_type.toUpperCase()}</p>
          <p class="text-xs text-secondary mb-0">${file.file_type}</p>
        </td>
        <td class="align-middle text-center text-sm">${status}</td>
        <td class="align-middle text-center">
          <span class="text-secondary text-xs font-weight-bold">${uploadDate}</span>
        </td>
        <td class="align-middle">
          <button class="btn btn-link text-danger text-gradient px-3 mb-0" onclick="deleteFile(${
            file.id
          }, '${file.filename}')">
            <i class="material-icons text-sm me-2">delete</i>Delete
          </button>
        </td>
      </tr>
    `);
    });
  }

  function showAlert(type, message) {
    const alertClass =
      type === "success"
        ? "bg-gradient-success"
        : type === "danger"
        ? "bg-gradient-danger"
        : type === "warning"
        ? "bg-gradient-warning"
        : "bg-gradient-info";

    const alertHtml = `
    <div class="alert ${alertClass} alert-dismissible text-white fade show" role="alert">
      <span class="text-sm">${message}</span>
      <button type="button" class="btn-close text-lg py-3 opacity-10" data-bs-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
  `;

    $(".alert").remove();

    $(".container-fluid.py-4").prepend(alertHtml);

    setTimeout(function () {
      $(".alert").fadeOut();
    }, 5000);
  }

  $("#uploadModal").on("hidden.bs.modal", function () {
    $("#uploadForm")[0].reset();
    $("#uploadProgress").hide();
  });

  document.getElementById("fileInput").addEventListener("change", function (e) {
    const fileName = e.target.files[0]?.name || "";
    const label = this.nextElementSibling;
    if (fileName) {
      label.textContent = fileName;
      label.classList.add("active");
    }
  });
</script>
{% endblock javascripts %}
